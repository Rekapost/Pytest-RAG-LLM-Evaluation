import os
import pytest
import asyncio
import requests
from langchain_openai import ChatOpenAI
from ragas import SingleTurnSample
from ragas.llms import LangchainLLMWrapper
from ragas.metrics import LLMContextPrecisionWithoutReference
from dotenv import load_dotenv

# user_input -> query which user asks
# response -> response what LLM generates
# reference -> what is the ground truth means, we know about docs so like expected result, it is req when getting actual response
# retrived_context -> top k docs what it retrived fom vector database

@pytest.mark.asyncio
async def test_context_precision():
    #load_dotenv()
    #client = ChatOpenAI(api_key=os.getenv("OPENAI_API_KEY"))
    os.environ["OPENAI_API_KEY"] = "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"

    # 1. Create object of class for that specific metric, rag framweork provides each class declartion for every metric
    # that class have method where u get the score, every metric has its associated class in RAGAS Framework
    # to say irrelevant docs, AI is needed to scan query , response, retrival context and tell irrelevant context for the response it generated for the question asked.
    # so LLM is used, so send OpenAI/gemini object as argument to the class, so that class take help of chatgpt to sacn what are irrelevant,
    # then with that info it will do all calculation and tell score like precsion
    # power of LLM  + method metric -> score
    # so create class called ChatOpenAI from langchain
    # machine learning models to help ragas to tell irrelevant docs, to access the models langchain has given 1 API , using API we can access models and get response from models directly

    llm = ChatOpenAI(model="gpt-3.5-turbo",
                     temperature=0
                     #openai_api_key=os.getenv("OPENAI_API_KEY")
                     )  # gpt-4 class talks to open AI LLM, temperature = 0 how elaborate the ans is need , 0 gives exact ans without ellboarting
    # llm is object / instance for the class, now u can access openai llm

    # ragas framework cannot understand the object of langchain llm , so convert llm object so that ragas can understand, so Ragas gave class called Langchain which help u to port instance of langchain llm to llm what ragas can understand
    # so wrapper to convert to ragas
    langchain_llm = LangchainLLMWrapper(llm)  # class
    # langchain_llm object is now compatible with ragas

    context_precision = LLMContextPrecisionWithoutReference(llm=langchain_llm)  # class method for context precision
    # context_precision is the object of the metric,   now LLMContextPrecisionWithoutReference() method has info about openai llm
    # when llm tries to access openai , get api key from https://platform.openai.com/api-keys

    # 2. Feed data
    question = "How many articles are there in the Selenium Webdriver python course?"
    responseDict = requests.post("https://rahulshettyacademy.com/rag-llm/ask",
                                 json={
                                     "question": question,
                                     "chat_history": [
                                     ]
                                 }
                                 ).json()
    print(responseDict)

    # Dictionery is Key : value pair, get json response .json()
    # once object is created u need to send query , response , retrieve docs with this info class gives score based on the output
    # class have method to get score
    # single turn conversation
    # class, u have to send {"user_input", "response", "retrieved_contexts"}
    # API DATA
    sample = SingleTurnSample(
        user_input= question,    # test case input
        response= responseDict["answer"],
        retrieved_contexts=[
            responseDict["retrieved_docs"][0]["page_content"],
            responseDict["retrieved_docs"][1]["page_content"],
            responseDict["retrieved_docs"][2]["page_content"]
        ]

    )

    # U cannot get all args manaully , u need to get response dynamically from LLM, tomoroow new build will give diff response ,
    # u cant hardcode static ans from current build
    # so everytime u should dynamiccaly call RAG application, and get response from code and read json , reterive ans , feed dynamically into SingleTurnSample()data and proced

    # 3. Get the score
    # score can be generated by context precision object
    score = await context_precision.single_turn_ascore(sample)
    print(score)  # asynchromnus , That means it does not wait until the whole execution is complete. So to make it wait before proceeding, so add a keyword called await.
    # So await will help you to wait until the operations are done.  so add async to method def test_context_precision() and @pytest.mark.asyncio

    print(score)

    # Assertion   benchmark precsion > 0.8 to certify LLM for this metric
    assert score > 0.8  # test pass
    #Context_precision.py::test_context_precision PASSED  [100%]0.99999999995


   #STATIC DATA
    #sample = SingleTurnSample(
    #        user_input="How many articles are there in the Selenium Webdriver python course",
    #        response="There are 23 articles in the course.",
    #        retrieved_contexts=[
    #            "Complete Understanding on Selenium Python API Methods with real time Scenarios on LIVE Websites\n\"Last but not least\" you can clear any Interview and can Lead Entire Selenium Python Projects from Design Stage\nThis course includes:\n17.5 hours on-demand video\nAssignments\n23 articles\n9 downloadable resources\nAccess on mobile and TV\nCertificate of completion\nRequirements",
    #            "What you'll learn\n*****By the end of this course,You will be Mastered on Selenium Webdriver with strong Core JAVA basics\n****You will gain the ability to design PAGEOBJECT, DATADRIVEN&HYBRID Automation FRAMEWORKS from scratch\n*** InDepth understanding of real time Selenium CHALLENGES with 100 + examples\n*Complete knowledge on TestNG, MAVEN,ANT, JENKINS,LOG4J, CUCUMBER, HTML REPORTS,EXCEL API, GRID PARALLEL TESTING",
    #            "What you'll learn\nAt the end of this course, You will get complete knowledge on Python Automation using Selenium WebDriver\nYou will be able to implement Python Test Automation Frameworks from Scratch with all latest Technlogies\nComplete Understanding of Python Basics with many practise Examples to gain a solid exposure\nYou will be learning Python Unit Test Frameworks like PyTest which will helpful for Unit and Integration Testing",
    #            "Join in our Selenium Training community where 3 Million Students Learning Together which you will not see in any other Selenium courses on Udemy\nDescription\n**Learn Everything You Need to Know About Python Selenium Automation including Framework Even If You've Never Programmed Before in Python**"
    #            ])